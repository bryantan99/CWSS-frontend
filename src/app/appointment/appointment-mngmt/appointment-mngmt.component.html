<nz-table #appointmentTable
          [nzTitle]="tableTitle"
          [(nzPageIndex)]="pageIndex"
          [(nzPageSize)]="pageSize"
          [nzData]="displayData"
          [nzScroll]="{x: '960px'}"
          [nzLoading]="isLoading">
  <thead>
  <tr>
    <th nzWidth="80px">No.</th>
    <th>Appointment Purpose</th>
    <th>Appointment Datetime</th>
    <th>Appointment Status</th>
    <th>Action</th>
  </tr>
  </thead>
  <tbody>
  <tr *ngFor="let data of appointmentTable.data; let i = index">
    <td>{{ (pageIndex - 1) * pageSize + i + 1 }}</td>
    <td>{{data.appointmentPurpose}}</td>
    <td>{{(data.appointmentStartTime | date: 'short')}} -<br>{{(data.appointmentEndTime | date: 'short')}}</td>
    <td>
      <nz-tag *ngIf="data?.appointmentStatus === 'pending'" nzColor="gold">Pending</nz-tag>
      <nz-tag *ngIf="data?.appointmentStatus === 'confirmed'" nzColor="green">Confirmed</nz-tag>
      <nz-tag *ngIf="data?.appointmentStatus === 'completed'" nzColor="green">Completed</nz-tag>
      <nz-tag *ngIf="data?.appointmentStatus === 'cancelled'" nzColor="magenta">Cancelled</nz-tag>
      <span *ngIf="!data?.appointmentStatus">-</span>
    </td>
    <td>
      <button nz-button nz-dropdown [nzDropdownMenu]="actionMenu">
        Actions <i nz-icon nzType="down"></i>
      </button>
      <nz-dropdown-menu #actionMenu="nzDropdownMenu">
        <ul nz-menu>
          <li nz-menu-item>
            <a (click)="openDatetimeModal(data?.appointmentId)">Change Appointment Datetime</a>
          </li>
          <li nz-menu-item>
            <a nz-popconfirm nzPopconfirmTitle="Are you sure you want to cancel this appointment?"
               (nzOnConfirm)="cancelAppointment(data?.appointmentId)">Cancel Appointment</a>
          </li>
        </ul>
      </nz-dropdown-menu>
    </td>
  </tr>
  </tbody>
</nz-table>

<ng-template #tableTitle>
  <h4>Appointment</h4>

  <nz-row>
    <nz-col class="fw-bold text-start" [nzXs]="24" [nzSm]="7" [nzMd]="4">Date</nz-col>
    <nz-col [nzXs]="24" [nzSm]="16" [nzMd]="20">
      <nz-date-picker [(ngModel)]="selectedDate" (ngModelChange)="filterList($event)"></nz-date-picker>
    </nz-col>
  </nz-row>

</ng-template>

<nz-modal *ngIf="dateTimeModalIsVisible"
          [nzVisible]="dateTimeModalIsVisible"
          nzTitle="Change Appointment's Datetime"
          (nzOnCancel)="cancelChangeDatetime()">
  <ng-container *nzModalContent>
    <nz-alert nzType="info" nzMessage="Default duration for each appointment is 1 hour."></nz-alert>
    <form nz-form [formGroup]="changeAppointmentDatetimeForm">
      <nz-form-item>
        <nz-form-label [nzXs]="24" [nzMd]="8" class="fw-bold">Scheduled Datetime</nz-form-label>
        <nz-form-control [nzXs]="24" [nzMd]="16">
          {{ (appointment?.appointmentStartTime | date: 'short') || "-" }}
          - {{ (appointment?.appointmentEndTime | date: 'short') || "-" }}
        </nz-form-control>
      </nz-form-item>
      <nz-form-item>
        <nz-form-label [nzXs]="24" [nzMd]="8" nzRequired class="fw-bold test">New Date</nz-form-label>
        <nz-form-control [nzXs]="24" [nzMd]="16" [nzErrorTip]="dateErrorTpl">
          <nz-date-picker nzFormat="dd-MM-yyyy" formControlName="date"></nz-date-picker>
          <ng-template #dateErrorTpl let-control>
            <div *ngIf="control.invalid && (control.dirty || control.touched)">
              <div *ngIf="control.errors?.required">Please select a date!</div>
            </div>
          </ng-template>
        </nz-form-control>
      </nz-form-item>
      <nz-form-item>
        <nz-form-label [nzXs]="24" [nzMd]="8" nzRequired class="fw-bold test">New Time</nz-form-label>
        <nz-form-control [nzXs]="24" [nzMd]="16" [nzErrorTip]="timeErrorTpl">
          <nz-time-picker nzFormat="hh a" formControlName="time"></nz-time-picker>
          <ng-template #timeErrorTpl let-control>
            <div *ngIf="control.invalid && (control.dirty || control.touched)">
              <div *ngIf="control.errors?.required">Please select a time!</div>
            </div>
          </ng-template>
        </nz-form-control>
      </nz-form-item>
    </form>
  </ng-container>
  <div *nzModalFooter>
    <button nz-button nzType="default" (click)="cancelChangeDatetime()">Cancel</button>
    <button nz-button nzType="primary" [disabled]="!changeAppointmentDatetimeForm.valid" (click)="changeDatetime()">Update</button>
  </div>
</nz-modal>
