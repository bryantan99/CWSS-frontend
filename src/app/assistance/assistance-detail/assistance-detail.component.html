<nz-spin [nzSpinning]="isLoading">
  <nz-page-header nzBackIcon
                  (nzBack)="navigateToPreviousPage()">
    <nz-page-header-title style="text-overflow: unset; white-space: initial">Assistance Request Detail
    </nz-page-header-title>
    <nz-page-header-extra>
      <button nz-button nz-dropdown [nzDropdownMenu]="menu">
        Actions
        <i nz-icon nzType="down"></i>
      </button>
      <nz-dropdown-menu #menu="nzDropdownMenu">
        <ul nz-menu>
          <li nz-menu-item *ngIf="assistanceRecord?.assistanceStatus ==='pending' || isAdmin">
            <a (click)="onEditMode()">Edit/Update</a>
          </li>
          <li nz-menu-item *ngIf="assistanceRecord?.assistanceStatus === 'pending'">
            <a nz-popconfirm
               nzPopconfirmTitle="Are you sure you want to delete this request?"
               (nzOnConfirm)="deleteRec(assistanceRecord?.assistanceId)">Delete</a>
          </li>
          <li nz-menu-item>
            <a (click)="openCommentDrawer()">View comment</a>
          </li>
        </ul>
      </nz-dropdown-menu>
    </nz-page-header-extra>
    <nz-page-header-content>
      <form nz-form [formGroup]="form">
        <nz-form-item class="mb-2">
          <nz-form-label [nzSm]="24" [nzMd]="7" class="fw-bold text-start">Request ID</nz-form-label>
          <nz-form-control [nzSm]="24" [nzMd]="16">
            <span>{{ assistanceRecord?.assistanceId || "-"}}</span>
          </nz-form-control>
        </nz-form-item>

        <nz-form-item class="mb-2">
          <nz-form-label [nzSm]="24" [nzMd]="7" class="fw-bold text-start">Title</nz-form-label>
          <nz-form-control [nzSm]="24" [nzMd]="16" [nzErrorTip]="titleErrorTpl"
                           *ngIf="nzEdit && !isAdmin; else displayTitleTpl">
            <input nz-input type="text" formControlName="title">
            <ng-template #titleErrorTpl let-control>
              <div *ngIf="control.invalid && (control.touched || control.dirty)">
                <div *ngIf="control.errors?.required">Please input title!</div>
              </div>
            </ng-template>
          </nz-form-control>
        </nz-form-item>

        <nz-form-item class="mb-2">
          <nz-form-label [nzSm]="24" [nzMd]="7" class="fw-bold text-start">Description</nz-form-label>
          <nz-form-control [nzSm]="24" [nzMd]="16" [nzErrorTip]="descErrorTpl"
                           *ngIf="nzEdit && !isAdmin; else displayDescTpl">
            <textarea nz-input [rows]="4" formControlName="description"></textarea>
            <ng-template #descErrorTpl let-control>
              <div *ngIf="control.invalid && (control.dirty || control.touched)">
                <div *ngIf="control.errors?.required">
                  Please input assistance description!
                </div>
              </div>
            </ng-template>
          </nz-form-control>
        </nz-form-item>

        <nz-form-item class="mb-2">
          <nz-form-label [nzSm]="24" [nzMd]="7" class="fw-bold text-start">Status</nz-form-label>
          <nz-form-control [nzSm]="24" [nzMd]="16" [nzErrorTip]="statusErrorTpl"
                           *ngIf="nzEdit && isAdmin; else displayStatusTpl">
            <nz-select formControlName="status">
              <nz-option [nzValue]="'pending'" [nzLabel]="'Pending'"></nz-option>
              <nz-option [nzValue]="'processing'" [nzLabel]="'Processing'"></nz-option>
              <nz-option [nzValue]="'completed'" [nzLabel]="'Completed'"></nz-option>
              <nz-option [nzValue]="'cancelled'" [nzLabel]="'Cancelled'"></nz-option>
            </nz-select>
            <ng-template #statusErrorTpl let-control>
              <div *ngIf="control.invalid && (control.dirty || control.touched)">
                <div *ngIf="control.errors?.required">Please select a status!</div>
              </div>
            </ng-template>
          </nz-form-control>
        </nz-form-item>

        <nz-form-item class="mb-2">
          <nz-form-label [nzSm]="24" [nzMd]="7" class="fw-bold text-start">Person In-Charge</nz-form-label>
          <nz-form-control [nzSm]="24" [nzMd]="16" [nzErrorTip]="picErrorTpl"
                           *ngIf="nzEdit && isAdmin; else displayPicTpl">
              <nz-select nzShowSearch [nzPlaceHolder]="'Choose an admin'" formControlName="personInCharge">
                <nz-option *ngFor="let choice of adminChoices" [nzValue]="choice?.value"
                           [nzLabel]="choice?.text"></nz-option>
              </nz-select>
            <ng-template #picErrorTpl let-control>
              <div *ngIf="control.invalid && (control.dirty || control.touched)">
                <div *ngIf="control.errors?.required">Please select a person in-charge!</div>
              </div>
            </ng-template>
          </nz-form-control>
        </nz-form-item>

        <nz-form-item class="mb-2">
          <nz-form-label [nzSm]="24" [nzMd]="7" class="fw-bold text-start">Created Date</nz-form-label>
          <nz-form-control [nzSm]="24" [nzMd]="16">
            <span>{{ (assistanceRecord?.createdDate | date: 'medium') || "-"}}</span>
          </nz-form-control>
        </nz-form-item>

        <nz-form-item class="mb-2">
          <nz-form-label [nzSm]="24" [nzMd]="7" class="fw-bold text-start">Last Updated Date</nz-form-label>
          <nz-form-control [nzSm]="24" [nzMd]="16">
            <span>{{(assistanceRecord?.lastUpdatedDate | date: 'medium') || "-"}}</span>
          </nz-form-control>
        </nz-form-item>

        <nz-form-item class="mb-2" *ngIf="nzEdit">
          <nz-form-label [nzSm]="24" [nzMd]="7" nzNoColon></nz-form-label>
          <nz-form-control [nzSm]="24" [nzMd]="16">
            <button nz-button nzType="primary" class="me-2 mb-2" [disabled]="(!form.touched && !form.dirty) || !form.valid" (click)="submit()">Update</button>
            <button nz-button nzType="default" class="me-2 mb-2" (click)="cancelEdit()">Cancel</button>
          </nz-form-control>
        </nz-form-item>
      </form>
    </nz-page-header-content>
  </nz-page-header>

  <nz-page-header>
    <nz-page-header-title style="text-overflow: unset; white-space: initial">Help-seeker's Detail</nz-page-header-title>
    <nz-page-header-content>
      <form nz-form>
        <nz-form-item class="mb-2">
          <nz-form-label [nzSm]="24" [nzMd]="7" class="fw-bold text-start">Name</nz-form-label>
          <nz-form-control [nzSm]="24" [nzMd]="16">
            <a nz-typography [routerLink]="['/community-user/profile']"
               [queryParams]="{username: assistanceRecord?.communityUserBean?.username}"
               *ngIf="assistanceRecord?.communityUserBean">{{ assistanceRecord?.communityUserBean?.fullName }}
            </a>
            <span *ngIf="!assistanceRecord?.communityUserBean">-</span>
          </nz-form-control>
        </nz-form-item>

        <nz-form-item class="mb-2">
          <nz-form-label [nzSm]="24" [nzMd]="7" class="fw-bold text-start">Contact No.</nz-form-label>
          <nz-form-control [nzSm]="24" [nzMd]="16">
            <span>{{ assistanceRecord?.communityUserBean?.contactNo || "-" }}</span>
          </nz-form-control>
        </nz-form-item>
      </form>
    </nz-page-header-content>
  </nz-page-header>
</nz-spin>

<nz-drawer *ngIf="commentDrawerIsVisible"
           [(nzVisible)]="commentDrawerIsVisible"
           [nzTitle]="'Follow-up Comment'"
           [nzWidth]="320"
           (nzOnClose)="closeCommentDrawer()">
  <ng-container *nzDrawerContent>
    <app-assistance-comment [assistanceId]="assistanceId"></app-assistance-comment>
  </ng-container>
</nz-drawer>

<ng-template #displayTitleTpl>
  <nz-form-control [nzSm]="24" [nzMd]="16">
    {{ assistanceRecord?.assistanceTitle || "-" }}
  </nz-form-control>
</ng-template>

<ng-template #displayDescTpl>
  <nz-form-control [nzSm]="24" [nzMd]="16">
    {{ assistanceRecord?.assistanceDescription || "-" }}
  </nz-form-control>
</ng-template>

<ng-template #displayStatusTpl>
  <nz-form-control [nzSm]="24" [nzMd]="16">
    <nz-tag *ngIf="assistanceRecord?.assistanceStatus === 'pending'" nzColor="gold">Pending</nz-tag>
    <nz-tag *ngIf="assistanceRecord?.assistanceStatus === 'processing'" nzColor="blue">Processing</nz-tag>
    <nz-tag *ngIf="assistanceRecord?.assistanceStatus === 'completed'" nzColor="green">Completed</nz-tag>
    <nz-tag *ngIf="assistanceRecord?.assistanceStatus === 'cancelled'" nzColor="magenta">Cancel</nz-tag>
    <span *ngIf="!assistanceRecord?.assistanceStatus">-</span>
  </nz-form-control>
</ng-template>

<ng-template #displayPicTpl>
  <nz-form-control [nzSm]="24" [nzMd]="16">
    <span>{{ assistanceRecord?.adminBean?.fullName || "-" }}</span>
  </nz-form-control>
</ng-template>
